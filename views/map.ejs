<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<style>
    #map {
        height: 100%;
    }
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
    }
    /*.overlaybox {position:relative;width:360px;height:350px;background:url('https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/box_movie.png') no-repeat;padding:15px 10px;}*/
    .overlaybox {position:relative;width:200px;height:150px; background-color: antiquewhite}
    .overlaybox div, ul {overflow:hidden;margin:0;padding:0;}
    .overlaybox li {list-style: none;}
    /*.overlaybox .boxtitle {color:#fff;font-size:16px;font-weight:bold;background: url('https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/arrow_white.png') no-repeat right 120px center;margin-bottom:8px;}*/
    /*.overlaybox .first {position:relative;width:247px;height:136px;background: url('https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/thumb.png') no-repeat;margin-bottom:8px;}*/
    .overlaybox .first {position:relative;width:100%;height:100%;margin-bottom:8px;}
    .first .text {color:#fff;font-weight:bold;}
    .first .triangle {position:absolute;width:48px;height:48px;top:0;left:0;background: url('https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/triangle.png') no-repeat; padding:6px;font-size:18px;}
    .first .movietitle {position:absolute;width:100%;bottom:0;background:rgba(0,0,0,0.4);padding:7px 15px;font-size:14px;}

    #gpsEmpthy {
        height: 300px;
        background-color: azure;
        position: absolute;
        clear: left;
        float: left;
        width: 100%;
        left: 0;
        bottom: 0px;
    }
</style>
<body>
<script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBSAMsNZweI-C7zl0yDiAwroebVp9Xl-Hs&callback=initMap"></script>
<div id="map"></div>
<!--<div id="content">Hello world!</div>-->
<div id="gpsEmpthy">
    <h2> 📍위치를 찾을 수 없어요!</h2>
    <div id="gpsEmpthyList" style="display: inline"></div>
</div>
<script>
    let map, popup, Popup;
    var photos = <%- JSON.stringify(data) %>
    console.log(photos);
    // Initialize and add the map
    function initMap() {
        const uluru = { lat: -25.344, lng: 131.036 };
        // The map, centered at Uluru
        map = new google.maps.Map(document.getElementById("map"), {
            zoom: 3,
            center: uluru,
        });

        function getContentString(url, happiness, rank) {
            return `<div class="overlaybox">
                 <div class="first" style="background-image: url('${url}'); background-size: cover; background-repeat: no-repeat; background-position: center center;  ">
                    <div class="triangle text">${rank}</div>
                    <div class="movietitle text">🌟행복지수 ${happiness}🌟</div>
                   </div>
            </div>`
        }

        photos.forEach((photo, idx) => {
            if(photo.lat && photo.lng) { // gps 값이 없으면 skip
                const position = { lat: Number(photo.lat), lng: Number(photo.lng) };
                // The marker, positioned at Uluru
                const marker = new google.maps.Marker({
                    position,
                    map: map,
                });

                let infowindow = new google.maps.InfoWindow({
                    content: getContentString(photo.url, photo.avgHappinessRate, idx + 1),
                    position
                });

                // infowindow
                infowindow.open({
                    anchor: marker,
                    map,
                    shouldFocus: false,
                });
            } else { // 없으면..
                const list = document.querySelector('#gpsEmpthyList');
                let div = document.createElement('div');
                div.classList.add('overlaybox');
                div.innerHTML = `<div class="first" style="background-image: url('${photo.url}'); background-size: cover; background-repeat: no-repeat; background-position: center center;  ">
                            <div class="triangle text">${idx+1}</div>
                            <div class="movietitle text">🌟행복지수 ${photo.avgHappinessRate}🌟</div>
                        </div>`;

                list.appendChild(div);
            }
        })
    }

</script>

</body>
</html>